# 网约车系统后台管理接口文档

## 1. 接口概述

### 1.1 基本信息
- **Base URL**: `https://api.ridehailing.com/v1`
- **认证方式**: JWT Bearer Token
- **内容类型**: `application/json`
- **字符编码**: UTF-8

### 1.2 通用响应格式
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "code": 200,
  "timestamp": "2025-07-16T10:30:00Z",
  "request_id": "req_123456789"
}
```

### 1.3 错误响应格式
```json
{
  "success": false,
  "error": "错误描述",
  "code": 400,
  "details": "详细错误信息",
  "timestamp": "2025-07-16T10:30:00Z",
  "request_id": "req_123456789"
}
```

### 1.4 HTTP状态码说明
- `200` - 操作成功
- `201` - 创建成功
- `400` - 请求参数错误
- `401` - 未授权
- `403` - 权限不足
- `404` - 资源不存在
- `500` - 服务器内部错误

---

## 2. 用户认证模块

### 2.1 微信用户注册/登录
**接口路径**: `POST /auth/wechat/login`
**权限要求**: 公开接口

#### 请求参数
```json
{
  "code": "wx_temp_code_123",
  "encryptedData": "encrypted_user_data",
  "iv": "initialization_vector"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user_id": "user_123456",
    "role": "customer",
    "expires_in": 7200,
    "user_info": {
      "nickname": "张三",
      "avatar": "https://wx.qlogo.cn/...",
      "phone": "138****5678"
    }
  },
  "message": "登录成功"
}
```

### 2.2 司机注册
**接口路径**: `POST /auth/driver/register`
**权限要求**: 需要用户JWT Token

#### 请求参数
```json
{
  "license_number": "330100199001011234",
  "license_image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
  "name": "李四",
  "phone": "139****8765"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "status": "pending",
    "driver_id": "driver_123456",
    "verify_status": "verifying",
    "estimated_review_time": "24小时内"
  },
  "message": "司机注册申请已提交"
}
```

### 2.3 管理员登录
**接口路径**: `POST /auth/admin/login`
**权限要求**: 公开接口

#### 请求参数
```json
{
  "phone": "13800138000",
  "password": "admin123456"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user_id": "admin_001",
    "role": "admin",
    "expires_in": 7200,
    "permissions": ["user_manage", "vehicle_audit", "order_manage"]
  },
  "message": "管理员登录成功"
}
```

### 2.4 Token续期
**接口路径**: `POST /auth/refresh`
**权限要求**: 需要有效JWT Token

#### 请求参数
```json
{
  "refresh_token": "refresh_token_string"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "token": "new_jwt_token",
    "expires_in": 7200
  },
  "message": "Token续期成功"
}
```

---

## 3. 车辆管理模块

### 3.1 司机提交/修改车辆信息
**接口路径**: `POST /vehicles` (新增) / `PUT /vehicles/{vehicle_id}` (修改)
**权限要求**: 已审核通过的司机

#### 请求参数
```json
{
  "plate_number": "浙A12345",
  "vehicle_type": "轿车",
  "brand": "丰田",
  "model": "凯美瑞",
  "color": "白色",
  "year": 2020,
  "registration_image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
  "insurance_expiry": "2025-12-31"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "vehicle_id": "vehicle_123456",
    "status": "pending",
    "verify_status": "verifying",
    "submit_time": "2025-07-16T10:30:00Z"
  },
  "message": "车辆信息已提交审核"
}
```

### 3.2 获取车辆列表
**接口路径**: `GET /vehicles`
**权限要求**: 司机查看自己的车辆，管理员查看所有车辆

#### 请求参数
```
GET /vehicles?status=pending&page=1&page_size=10&driver_id=driver_123
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "vehicles": [
      {
        "id": "vehicle_123456",
        "driver_id": "driver_123",
        "driver_name": "李四",
        "plate_number": "浙A12345",
        "vehicle_type": "轿车",
        "brand": "丰田",
        "model": "凯美瑞",
        "status": "pending",
        "submit_time": "2025-07-16T10:30:00Z",
        "review_time": null
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 10,
      "total_count": 25,
      "total_pages": 3
    }
  },
  "message": "获取车辆列表成功"
}
```

### 3.3 管理员审核车辆
**接口路径**: `POST /vehicles/{vehicle_id}/audit`
**权限要求**: 管理员

#### 请求参数
```json
{
  "action": "approve",
  "comment": "车辆信息完整，审核通过"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "vehicle_id": "vehicle_123456",
    "status": "approved",
    "review_time": "2025-07-16T10:30:00Z",
    "reviewer": "admin_001"
  },
  "message": "车辆审核完成"
}
```

---

## 4. 订单管理模块

### 4.1 创建订单
**接口路径**: `POST /orders`
**权限要求**: 客户

#### 请求参数
```json
{
  "start_location": {
    "lat": 30.2741,
    "lng": 120.1551,
    "address": "杭州市西湖区文三路"
  },
  "end_location": {
    "lat": 30.2467,
    "lng": 120.1651,
    "address": "杭州市西湖区黄龙体育中心"
  },
  "book_time": "2025-07-16T14:00:00Z",
  "passenger_count": 1,
  "special_requirements": "需要儿童座椅"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "order_id": "order_123456789",
    "routes": [
      {
        "route_id": "route_001",
        "distance": 8.5,
        "duration": 18,
        "toll_fee": 0,
        "estimated_price": 25.5
      }
    ],
    "status": "created",
    "create_time": "2025-07-16T10:30:00Z"
  },
  "message": "订单创建成功"
}
```

### 4.2 智能派单
**接口路径**: `POST /orders/{order_id}/dispatch`
**权限要求**: 系统自动调用或管理员手动触发

#### 请求参数
```json
{
  "dispatch_type": "auto",
  "radius": 5000,
  "priority": "normal"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "order_id": "order_123456789",
    "dispatch_type": "auto",
    "candidate_drivers": [
      {
        "driver_id": "driver_001",
        "driver_name": "王师傅",
        "distance": 1.2,
        "rating": 4.8,
        "vehicle_info": "浙A12345 丰田凯美瑞",
        "estimated_arrival": 5
      }
    ],
    "status": "dispatching"
  },
  "message": "开始派单"
}
```

### 4.3 司机接单
**接口路径**: `POST /orders/{order_id}/accept`
**权限要求**: 司机

#### 请求参数
```json
{
  "estimated_arrival": 8,
  "current_location": {
    "lat": 30.2741,
    "lng": 120.1551
  }
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "order_id": "order_123456789",
    "driver_id": "driver_001",
    "status": "assigned",
    "estimated_arrival": 8,
    "customer_info": {
      "name": "张**",
      "phone": "138****5678"
    }
  },
  "message": "接单成功"
}
```

### 4.4 获取订单列表
**接口路径**: `GET /orders`
**权限要求**: 客户查看自己订单，司机查看接单订单，管理员查看所有订单

#### 请求参数
```
GET /orders?status=ongoing&date_start=2025-07-01&date_end=2025-07-16&page=1&page_size=20
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": "order_123456789",
        "customer_id": "user_123456",
        "customer_name": "张**",
        "driver_id": "driver_001",
        "driver_name": "王师傅",
        "start_location": {
          "lat": 30.2741,
          "lng": 120.1551,
          "address": "杭州市西湖区文三路"
        },
        "end_location": {
          "lat": 30.2467,
          "lng": 120.1651,
          "address": "杭州市西湖区黄龙体育中心"
        },
        "status": "ongoing",
        "create_time": "2025-07-16T10:30:00Z",
        "accept_time": "2025-07-16T10:32:00Z",
        "estimated_price": 25.5
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 20,
      "total_count": 156,
      "total_pages": 8
    }
  },
  "message": "获取订单列表成功"
}
```

### 4.5 订单详情
**接口路径**: `GET /orders/{order_id}`
**权限要求**: 订单相关用户或管理员

#### 响应示例
```json
{
  "success": true,
  "data": {
    "id": "order_123456789",
    "customer_info": {
      "id": "user_123456",
      "name": "张**",
      "phone": "138****5678"
    },
    "driver_info": {
      "id": "driver_001",
      "name": "王师傅",
      "phone": "139****8765",
      "vehicle": "浙A12345 丰田凯美瑞",
      "rating": 4.8
    },
    "route_info": {
      "start_location": {
        "lat": 30.2741,
        "lng": 120.1551,
        "address": "杭州市西湖区文三路"
      },
      "end_location": {
        "lat": 30.2467,
        "lng": 120.1651,
        "address": "杭州市西湖区黄龙体育中心"
      },
      "actual_route": {
        "distance": 8.7,
        "duration": 22,
        "path": [
          {"lat": 30.2741, "lng": 120.1551},
          {"lat": 30.2650, "lng": 120.1580}
        ]
      }
    },
    "status": "completed",
    "timeline": [
      {
        "status": "created",
        "time": "2025-07-16T10:30:00Z",
        "description": "订单创建"
      },
      {
        "status": "assigned",
        "time": "2025-07-16T10:32:00Z",
        "description": "司机接单"
      }
    ],
    "payment_info": {
      "total_amount": 26.0,
      "payment_method": "wechat_pay",
      "payment_status": "paid",
      "payment_time": "2025-07-16T11:15:00Z"
    }
  },
  "message": "获取订单详情成功"
}
```

### 4.6 实时位置更新
**接口路径**: `POST /orders/{order_id}/location`
**权限要求**: 司机

#### 请求参数
```json
{
  "current_location": {
    "lat": 30.2650,
    "lng": 120.1580
  },
  "heading": 90,
  "speed": 35
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "order_id": "order_123456789",
    "location_updated": true,
    "estimated_arrival": 12
  },
  "message": "位置更新成功"
}
```

---

## 5. 支付模块

### 5.1 发起支付
**接口路径**: `POST /payments`
**权限要求**: 客户

#### 请求参数
```json
{
  "order_id": "order_123456789",
  "payment_method": "wechat_pay",
  "amount": 26.0
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "payment_id": "pay_123456789",
    "payment_url": "weixin://wxpay/bizpayurl?pr=abcdefg",
    "qr_code": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB...",
    "expires_in": 300
  },
  "message": "支付订单创建成功"
}
```

### 5.2 支付状态查询
**接口路径**: `GET /payments/{payment_id}`
**权限要求**: 客户或管理员

#### 响应示例
```json
{
  "success": true,
  "data": {
    "payment_id": "pay_123456789",
    "order_id": "order_123456789",
    "status": "paid",
    "amount": 26.0,
    "payment_time": "2025-07-16T11:15:00Z",
    "transaction_id": "wx_transaction_123456"
  },
  "message": "支付状态查询成功"
}
```

### 5.3 支付回调
**接口路径**: `POST /payments/callback/wechat`
**权限要求**: 微信服务器回调

#### 请求参数
```json
{
  "transaction_id": "wx_transaction_123456",
  "out_trade_no": "pay_123456789",
  "total_fee": 2600,
  "result_code": "SUCCESS"
}
```

#### 响应示例
```json
{
  "success": true,
  "message": "支付回调处理成功"
}
```

---

## 6. 评价模块

### 6.1 提交评价
**接口路径**: `POST /reviews`
**权限要求**: 客户

#### 请求参数
```json
{
  "order_id": "order_123456789",
  "rating": 5,
  "comment": "司机服务很好，车辆干净，准时到达",
  "tags": ["服务好", "准时", "车辆整洁"]
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "review_id": "review_123456",
    "order_id": "order_123456789",
    "rating": 5,
    "submit_time": "2025-07-16T11:20:00Z"
  },
  "message": "评价提交成功"
}
```

### 6.2 获取评价列表
**接口路径**: `GET /reviews`
**权限要求**: 司机查看自己的评价，管理员查看所有评价

#### 请求参数
```
GET /reviews?driver_id=driver_001&page=1&page_size=10&rating_min=4
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "reviews": [
      {
        "id": "review_123456",
        "order_id": "order_123456789",
        "customer_name": "张**",
        "rating": 5,
        "comment": "司机服务很好，车辆干净，准时到达",
        "tags": ["服务好", "准时", "车辆整洁"],
        "create_time": "2025-07-16T11:20:00Z"
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 10,
      "total_count": 48,
      "total_pages": 5
    },
    "statistics": {
      "average_rating": 4.7,
      "total_reviews": 48,
      "rating_distribution": {
        "5": 32,
        "4": 12,
        "3": 3,
        "2": 1,
        "1": 0
      }
    }
  },
  "message": "获取评价列表成功"
}
```

---

## 7. 管理员模块

### 7.1 用户管理
**接口路径**: `GET /admin/users`
**权限要求**: 管理员

#### 请求参数
```
GET /admin/users?role=driver&status=pending&register_date_start=2025-07-01&page=1&page_size=20
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "driver_001",
        "nickname": "李四",
        "phone": "139****8765",
        "role": "driver",
        "status": "pending",
        "register_time": "2025-07-16T09:30:00Z",
        "last_login": "2025-07-16T10:15:00Z",
        "vehicle_count": 1,
        "order_count": 0
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 20,
      "total_count": 35,
      "total_pages": 2
    }
  },
  "message": "获取用户列表成功"
}
```

### 7.2 司机审核
**接口路径**: `POST /admin/drivers/{driver_id}/audit`
**权限要求**: 管理员

#### 请求参数
```json
{
  "action": "approve",
  "comment": "驾驶证信息验证通过"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "driver_id": "driver_001",
    "status": "approved",
    "review_time": "2025-07-16T11:30:00Z",
    "reviewer": "admin_001"
  },
  "message": "司机审核完成"
}
```

### 7.3 数据统计
**接口路径**: `GET /admin/statistics`
**权限要求**: 管理员

#### 请求参数
```
GET /admin/statistics?date=2025-07-16&type=daily
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "date": "2025-07-16",
    "orders": {
      "total": 126,
      "completed": 98,
      "canceled": 18,
      "ongoing": 10
    },
    "revenue": {
      "total": 2580.5,
      "average_per_order": 26.3
    },
    "users": {
      "active_customers": 86,
      "active_drivers": 34,
      "new_registrations": 8
    },
    "vehicles": {
      "pending_review": 3,
      "approved": 67,
      "rejected": 2
    }
  },
  "message": "统计数据获取成功"
}
```

---

## 8. 异常处理模块

### 8.1 纠纷处理
**接口路径**: `POST /disputes`
**权限要求**: 客户、司机或管理员

#### 请求参数
```json
{
  "order_id": "order_123456789",
  "dispute_type": "complaint",
  "description": "司机绕路行驶，实际费用超出预期",
  "evidence": [
    "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
  ]
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "dispute_id": "dispute_123456",
    "order_id": "order_123456789",
    "status": "submitted",
    "estimated_resolve_time": "48小时内",
    "submit_time": "2025-07-16T12:00:00Z"
  },
  "message": "纠纷申请已提交"
}
```

### 8.2 路线预警
**接口路径**: `POST /alerts/route-deviation`
**权限要求**: 系统自动触发

#### 请求参数
```json
{
  "order_id": "order_123456789",
  "driver_id": "driver_001",
  "current_location": {
    "lat": 30.2800,
    "lng": 120.1200
  },
  "deviation_distance": 3.2,
  "speed": 45
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "alert_id": "alert_123456",
    "order_id": "order_123456789",
    "level": 2,
    "message": "司机偏离预定路线3.2公里",
    "create_time": "2025-07-16T12:30:00Z",
    "auto_notify_admin": true
  },
  "message": "路线预警已生成"
}
```

---

## 9. 司机功能模块

### 9.1 司机设置
**接口路径**: `PUT /drivers/settings`
**权限要求**: 司机

#### 请求参数
```json
{
  "auto_accept": true,
  "work_status": "online",
  "service_radius": 10,
  "vehicle_type_preference": ["轿车", "SUV"]
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "driver_id": "driver_001",
    "settings_updated": true,
    "update_time": "2025-07-16T13:00:00Z"
  },
  "message": "司机设置更新成功"
}
```

### 9.2 收入查询
**接口路径**: `GET /drivers/income`
**权限要求**: 司机

#### 请求参数
```
GET /drivers/income?date_start=2025-07-01&date_end=2025-07-16&type=daily
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "period": {
      "start": "2025-07-01",
      "end": "2025-07-16"
    },
    "income": {
      "total": 3250.8,
      "orders_count": 128,
      "average_per_order": 25.4,
      "daily_breakdown": [
        {
          "date": "2025-07-16",
          "income": 268.5,
          "orders": 11
        }
      ]
    },
    "statistics": {
      "online_hours": 156,
      "acceptance_rate": 0.92,
      "completion_rate": 0.98
    }
  },
  "message": "收入查询成功"
}
```

### 9.3 提现申请
**接口路径**: `POST /drivers/withdrawal`
**权限要求**: 司机

#### 请求参数
```json
{
  "amount": 1000.0,
  "bank_account": "6228****1234",
  "bank_name": "中国银行"
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "withdrawal_id": "withdrawal_123456",
    "amount": 1000.0,
    "status": "pending",
    "estimated_arrival": "1-3个工作日",
    "submit_time": "2025-07-16T14:00:00Z"
  },
  "message": "提现申请已提交"
}
```

---

## 10. 通知模块

### 10.1 推送通知
**接口路径**: `POST /notifications`
**权限要求**: 系统内部调用

#### 请求参数
```json
{
  "user_id": "user_123456",
  "type": "order_status",
  "title": "订单状态更新",
  "message": "您的订单已完成，请进行评价",
  "data": {
    "order_id": "order_123456789",
    "action": "review"
  }
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "notification_id": "notif_123456",
    "send_time": "2025-07-16T14:30:00Z",
    "push_result": "sent"
  },
  "message": "通知发送成功"
}
```

### 10.2 获取通知列表
**接口路径**: `GET /notifications`
**权限要求**: 用户

#### 请求参数
```
GET /notifications?status=unread&page=1&page_size=20
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "notifications": [
      {
        "id": "notif_123456",
        "type": "order_status",
        "title": "订单状态更新",
        "message": "您的订单已完成，请进行评价",
        "status": "unread",
        "create_time": "2025-07-16T14:30:00Z",
        "data": {
          "order_id": "order_123456789"
        }
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 20,
      "total_count": 15,
      "total_pages": 1
    },
    "unread_count": 8
  },
  "message": "获取通知列表成功"
}
```

---

## 11. 地图服务模块

### 11.1 地理编码
**接口路径**: `GET /maps/geocode`
**权限要求**: 需要JWT Token

#### 请求参数
```
GET /maps/geocode?address=杭州市西湖区文三路
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "address": "杭州市西湖区文三路",
    "location": {
      "lat": 30.2741,
      "lng": 120.1551
    },
    "formatted_address": "浙江省杭州市西湖区文三路",
    "poi_info": {
      "name": "文三路地铁站",
      "category": "地铁站",
      "distance": 150
    }
  },
  "message": "地理编码成功"
}
```

### 11.2 路线规划
**接口路径**: `GET /maps/route`
**权限要求**: 需要JWT Token

#### 请求参数
```
GET /maps/route?start_lat=30.2741&start_lng=120.1551&end_lat=30.2467&end_lng=120.1651&route_type=fastest
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "routes": [
      {
        "route_id": "route_001",
        "distance": 8.5,
        "duration": 18,
        "toll_fee": 0,
        "path": [
          {"lat": 30.2741, "lng": 120.1551},
          {"lat": 30.2650, "lng": 120.1580},
          {"lat": 30.2467, "lng": 120.1651}
        ],
        "instructions": [
          {
            "instruction": "从文三路向南行驶",
            "distance": 500,
            "duration": 2
          },
          {
            "instruction": "左转进入教工路",
            "distance": 800,
            "duration": 3
          }
        ]
      }
    ],
    "traffic_info": {
      "status": "smooth",
      "delay": 0
    }
  },
  "message": "路线规划成功"
}
```

### 11.3 附近司机查询
**接口路径**: `GET /maps/nearby-drivers`
**权限要求**: 客户或管理员

#### 请求参数
```
GET /maps/nearby-drivers?lat=30.2741&lng=120.1551&radius=5000&limit=10
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "drivers": [
      {
        "driver_id": "driver_001",
        "name": "王师傅",
        "location": {
          "lat": 30.2750,
          "lng": 120.1560
        },
        "distance": 120,
        "rating": 4.8,
        "vehicle_info": {
          "plate_number": "浙A12345",
          "brand": "丰田",
          "model": "凯美瑞"
        },
        "status": "online",
        "estimated_arrival": 3
      }
    ],
    "total_count": 8,
    "search_radius": 5000
  },
  "message": "附近司机查询成功"
}
```

---

## 12. 文件上传模块

### 12.1 图片上传
**接口路径**: `POST /upload/image`
**权限要求**: 需要JWT Token

#### 请求参数
```json
{
  "image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
  "type": "license",
  "compress": true
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "file_id": "file_123456",
    "url": "https://cdn.ridehailing.com/images/license/file_123456.jpg",
    "size": 245760,
    "mime_type": "image/jpeg",
    "upload_time": "2025-07-16T15:00:00Z"
  },
  "message": "图片上传成功"
}
```

### 12.2 文件删除
**接口路径**: `DELETE /upload/{file_id}`
**权限要求**: 文件所有者或管理员

#### 响应示例
```json
{
  "success": true,
  "data": {
    "file_id": "file_123456",
    "deleted": true,
    "delete_time": "2025-07-16T15:30:00Z"
  },
  "message": "文件删除成功"
}
```

---

## 13. 系统配置模块

### 13.1 获取系统配置
**接口路径**: `GET /config`
**权限要求**: 需要JWT Token

#### 响应示例
```json
{
  "success": true,
  "data": {
    "app_config": {
      "version": "1.0.0",
      "force_update": false,
      "maintenance": false
    },
    "map_config": {
      "default_city": "杭州",
      "map_provider": "baidu",
      "api_key": "your_map_api_key"
    },
    "payment_config": {
      "available_methods": ["wechat_pay", "alipay"],
      "min_amount": 5.0,
      "max_amount": 500.0
    },
    "business_rules": {
      "max_wait_time": 10,
      "auto_cancel_time": 30,
      "max_booking_days": 7
    }
  },
  "message": "系统配置获取成功"
}
```

### 13.2 更新系统配置
**接口路径**: `PUT /config`
**权限要求**: 管理员

#### 请求参数
```json
{
  "business_rules": {
    "max_wait_time": 15,
    "auto_cancel_time": 25
  }
}
```

#### 响应示例
```json
{
  "success": true,
  "data": {
    "updated_fields": ["business_rules.max_wait_time", "business_rules.auto_cancel_time"],
    "update_time": "2025-07-16T16:00:00Z"
  },
  "message": "系统配置更新成功"
}
```

---

## 14. WebSocket 实时通信

### 14.1 连接建立
**WebSocket URL**: `wss://api.ridehailing.com/v1/ws`
**权限要求**: 需要JWT Token

#### 连接参数
```
wss://api.ridehailing.com/v1/ws?token=your_jwt_token&user_id=user_123456
```

#### 连接成功响应
```json
{
  "type": "connection",
  "status": "connected",
  "user_id": "user_123456",
  "timestamp": "2025-07-16T16:30:00Z"
}
```

### 14.2 订单状态推送
#### 推送消息格式
```json
{
  "type": "order_status",
  "data": {
    "order_id": "order_123456789",
    "status": "assigned",
    "driver_info": {
      "name": "王师傅",
      "phone": "139****8765",
      "vehicle": "浙A12345 丰田凯美瑞"
    },
    "estimated_arrival": 8
  },
  "timestamp": "2025-07-16T16:32:00Z"
}
```

### 14.3 位置更新推送
#### 推送消息格式
```json
{
  "type": "location_update",
  "data": {
    "order_id": "order_123456789",
    "driver_location": {
      "lat": 30.2650,
      "lng": 120.1580
    },
    "heading": 90,
    "speed": 35,
    "estimated_arrival": 5
  },
  "timestamp": "2025-07-16T16:35:00Z"
}
```

---

## 15. 错误码参考

### 15.1 通用错误码
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400001 | 请求参数错误 | 检查参数格式和必填字段 |
| 400002 | 参数类型错误 | 确认参数类型是否正确 |
| 400003 | 参数值超出范围 | 检查参数值是否在允许范围内 |
| 401001 | Token无效 | 重新登录获取新Token |
| 401002 | Token过期 | 使用refresh_token刷新 |
| 403001 | 权限不足 | 确认用户角色和权限 |
| 404001 | 资源不存在 | 确认资源ID是否正确 |
| 500001 | 服务器内部错误 | 稍后重试或联系技术支持 |

### 15.2 业务错误码
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 100001 | 微信授权失败 | 重新进行微信授权 |
| 100002 | 驾驶证验证失败 | 检查驾驶证信息是否正确 |
| 100003 | 车牌号已存在 | 使用其他车牌号或联系管理员 |
| 200001 | 订单创建失败 | 检查地址信息是否正确 |
| 200002 | 无可用司机 | 扩大搜索范围或稍后重试 |
| 200003 | 订单状态不允许此操作 | 检查订单当前状态 |
| 300001 | 支付失败 | 检查支付信息或更换支付方式 |
| 300002 | 余额不足 | 充值后重试 |
| 400001 | 评价已存在 | 无法重复评价同一订单 |

---

## 16. 接口调用示例

### 16.1 完整订单流程示例

#### 步骤1：客户登录
```javascript
// 微信登录
const loginResponse = await fetch('/api/v1/auth/wechat/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    code: 'wx_code_from_wechat',
    encryptedData: 'encrypted_data',
    iv: 'iv_string'
  })
});
const loginData = await loginResponse.json();
const token = loginData.data.token;
```

#### 步骤2：创建订单
```javascript
const orderResponse = await fetch('/api/v1/orders', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    start_location: {
      lat: 30.2741,
      lng: 120.1551,
      address: '杭州市西湖区文三路'
    },
    end_location: {
      lat: 30.2467,
      lng: 120.1651,
      address: '杭州市西湖区黄龙体育中心'
    }
  })
});
const orderData = await orderResponse.json();
const orderId = orderData.data.order_id;
```

#### 步骤3：订单完成后支付
```javascript
const paymentResponse = await fetch('/api/v1/payments', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    order_id: orderId,
    payment_method: 'wechat_pay',
    amount: 26.0
  })
});
const paymentData = await paymentResponse.json();
```

#### 步骤4：提交评价
```javascript
const reviewResponse = await fetch('/api/v1/reviews', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    order_id: orderId,
    rating: 5,
    comment: '司机服务很好，准时到达'
  })
});
```

### 16.2 司机工作流程示例

#### 步骤1：司机登录并上线
```javascript
// 司机登录
const driverLogin = await fetch('/api/v1/auth/wechat/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    code: 'driver_wx_code',
    encryptedData: 'encrypted_data',
    iv: 'iv_string'
  })
});

// 设置工作状态
await fetch('/api/v1/drivers/settings', {
  method: 'PUT',
  headers: {
    'Authorization': `Bearer ${driverToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    work_status: 'online',
    auto_accept: true
  })
});
```

#### 步骤2：接收并处理订单
```javascript
// 接单
const acceptResponse = await fetch(`/api/v1/orders/${orderId}/accept`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${driverToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    estimated_arrival: 8,
    current_location: {
      lat: 30.2741,
      lng: 120.1551
    }
  })
});
```

#### 步骤3：更新位置
```javascript
// 定期更新位置
setInterval(async () => {
  await fetch(`/api/v1/orders/${orderId}/location`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${driverToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      current_location: {
        lat: getCurrentLat(),
        lng: getCurrentLng()
      },
      heading: 90,
      speed: 35
    })
  });
}, 5000); // 每5秒更新一次
```

---

## 17. 测试环境信息

### 17.1 测试服务器
- **测试环境**: `https://test-api.ridehailing.com/v1`
- **数据库**: PostgreSQL 测试库
- **缓存**: Redis 测试实例
- **文件存储**: 测试OSS bucket

### 17.2 测试账户
| 角色 | 账户 | 密码 | 说明 |
|------|------|------|------|
| 管理员 | admin | admin123 | 全功能测试账户 |
| 客户 | customer1 | - | 微信登录测试 |
| 司机 | driver1 | - | 已审核通过司机 |
| 司机 | driver2 | - | 待审核司机 |

### 17.3 测试数据
- **测试订单**: 100+历史订单数据
- **测试车辆**: 20+已审核车辆
- **测试评价**: 50+真实评价数据
- **测试地址**: 杭州市范围内常用地址

---

## 18. 版本更新记录

### v1.0.0 (2025-07-16)
- 初始版本发布
- 完成基础用户认证功能
- 实现订单创建和管理
- 集成微信支付
- 添加评价系统
- 完成管理员后台功能

### 预计更新 v1.1.0
- 增加动态定价功能
- 完善通知推送系统
- 优化司机调度算法
- 添加客服系统
- 增加数据分析功能

---

## 19. 开发规范

### 19.1 API设计规范
- 遵循RESTful设计原则
- 统一使用JSON格式
- 采用标准HTTP状态码
- 接口版本控制（v1, v2等）

### 19.2 安全规范
- 所有接口必须使用HTTPS
- 敏感数据传输加密
- 实现请求频率限制
- 记录详细的访问日志

### 19.3 文档维护
- 接口变更及时更新文档
- 提供详细的示例代码
- 维护版本更新记录
- 定期Review文档准确性

---

## 20. 技术支持

### 20.1 联系方式
- **技术支持邮箱**: tech-support@ridehailing.com
- **API问题反馈**: api-feedback@ridehailing.com
- **紧急联系电话**: 400-123-4567

### 20.2 开发者社区
- **开发者论坛**: https://developer.ridehailing.com
- **GitHub仓库**: https://github.com/ridehailing/api-docs
- **API状态页面**: https://status.ridehailing.com

### 20.3 SLA承诺
- **API可用性**: 99.9%
- **响应时间**: 平均 < 500ms
- **支持响应**: 工作日24小时内回复

---

*本文档最后更新时间: 2025-07-16*
    "